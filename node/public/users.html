<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">

    <title>User Panel</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Loading Bootstrap -->
    <link href="bootstrap/css/bootstrap.css" rel="stylesheet">
    <!-- Loading Flat UI -->
    <link href="css/flat-ui.css" rel="stylesheet">
    <link rel="shortcut icon" href="images/favicon.ico">

    <script src="js/jquery-1.8.3.min.js"></script>
    <script src="js/jquery-ui-1.10.3.custom.min.js"></script>
    <script src="js/jquery.ui.touch-punch.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/bootstrap-select.js"></script>
    <script src="js/bootstrap-switch.js"></script>
    <script src="js/flatui-checkbox.js"></script>
    <script src="js/flatui-radio.js"></script>
    <script src="js/jquery.tagsinput.js"></script>
    <script src="js/jquery.placeholder.js"></script>

    <script src="js/grapnel.min.js"></script>


    <script type="text/javascript">

    var DATA_URL = '../';

   	$(document).ready(function() {
    	console.log('document ready.');
    	
    	fillUsers();

      var router = new Grapnel();

      router.get(':id?', function(req){
          var id = req.params.id,
              category = req.params.category;
          // GET http://mysite.com/#products/widgets/134
          console.log('dudee ', category, id);
          // => widgets 134
      });


	});

	function fillUsers() {
		console.log('fill users');
		var users_path = DATA_URL+'Users';
   		$.getJSON(users_path, function(users) {
   			users.forEach(function(user){
   				var controlOption = '<a class="user_control delete" data-toggle="modal" data-target="#confirm-delete">delete</a>'+
   									'/'+
   									'<a class="user_control" data-toggle="modal" href="#users">modify</a>';
   				var tr = '<tr>'+ 
   						 	'<th class="id">'+user.id+'</th>'+
   						 	'<th class="name">'+user.name+'</th>'+
   						 	'<th>'+controlOption+'</th>'+
   						 '</tr>';
   				$('#userList > tbody:last').append(tr);
   			});

   			addControl();
   		});
	}

	function addControl() {
		$('.user_control.delete').click(function() {
			var userTr = this.parentNode.parentNode,
				userName = userTr.getElementsByClassName('name')[0].innerHTML,
				userId = userTr.getElementsByClassName('id')[0].innerHTML;
			$('#confirm-delete').on('show.bs.modal', function(e) {
	            $( '.user-to-delete')
	            	.html('Delete user: #<strong>' + 
	            		  userId + ' ' + 
	            		  userName +
	            		  '</strong>');
	        	});
			var btnDelete = $('#confirm-delete').find('.btn.danger');
			btnDelete.unbind("click");
			btnDelete.click(function(e) {
				$('#confirm-delete').modal('hide');
				//deleteUser(userId, userName);
				deleteUserSuccess(userId, userName);
			});
		});
	}

	function deleteUser(userId, userName) {
		$.ajax({
            type: 'DELETE',
            url: DATA_URL+'deleteuser/' + userId,
            success: function(data, status) {
            	deleteUserSuccess(userId, userName);
            }
        }).done(function( response ) {
            if (response.msg === '') {
            	console.log('user deted');
            }
            else {
            }
            // update - recall populateTable
        });
	}

	function deleteUserSuccess(userId, userName) {
		console.log('User #'+userId+' '+userName+' correctly deleted');
		$('#alerttt-placeholder').append('<div id="alert-delete-user-success" class="alert alert-success" data-alert="alert"> User #'+userId+' '+userName+' correctly deleted</div>');
		setTimeout(function() {
			$("#alert-delete-user-success").fadeOut('slow',function() {
				$(this).remove();	
			})
		}, 3000);
	}

	

    </script>

    <style type="text/css">
    .user_control {
    	cursor: pointer;
    }
    </style>

  </head>
  <body>

	<div class="modal fade" 
		 id="confirm-delete" 
		 tabindex="-1" 
		 role="dialog" 
		 aria-labelledby="myModalLabel" 
		 aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
            
                <div class="modal-header">
                    <button type="button" 
                    		class="close" 
                    		data-dismiss="modal" 
                    		aria-hidden="true">&times;</button>
                    <h4 class="modal-title" 
                    	id="myModalLabel">Confirm Delete</h4>
                </div>
            
                <div class="modal-body">
                    <p>You are about to delete the user, this procedure is irreversible.</p>
                    <p>Do you want to proceed?</p>
                    <p class="user-to-delete"></p>
                </div>
                
                <div class="modal-footer">
                    <button type="button" 
                    		class="btn btn-default" 
                    		data-dismiss="modal">Cancel</button>
                    <a href="#" class="btn btn-danger danger">Delete</a>
                </div>
            </div>
        </div>
    </div>

  	<!--------------------------------------------------- /.container -->
    <div class="container">
        
    <div id="alerttt-placeholder"></div>

	<table class="table table-hover" id="userList">
		<thead>
			<tr>
				<th>#</th>
				<th>Name</th>
				<th>Control</th>
			</tr>
		</thead>
		<tbody></tbody>
	</table>

    </div>
    <!--------------------------------------------------- /.container -->
    
  </body>
</html>